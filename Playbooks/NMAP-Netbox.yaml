---
- name: Scan multiple networks and add live IPs to NetBox
  hosts: localhost
  gather_facts: no

  vars:
    # Sæt dine egne værdier / brug vault eller env vars i praksis
    netbox_url: "https://10.20.1.143/api/"
    netbox_token: "c1fda850572c1fe314d59ac389b5c1fb75217141"

   ---
- name: Scan network and add live IPs to NetBox
  hosts: localhost
  gather_facts: no
  vars:
    netbox_url: "https://10.20.1.143/api/"
    netbox_token: "c1fda850572c1fe314d59ac389b5c1fb75217141"
    scan_network_range: "10.20.0.0/23"

  tasks:

    - name: Scan network for live hosts
      ansible.builtin.command: "nmap -sn {{ scan_network_range }}"
      register: nmap_output

    - name: Extract IPs from nmap output
      set_fact:
        live_ips: >-
          {{
            nmap_output.stdout_lines
            | select('search', '^Nmap scan report for')
            | map('regex_search', '([0-9]{1,3}(?:\.[0-9]{1,3}){3})')
            | list
          }}


    - name: Print live IPs
      ansible.builtin.debug:
        var: live_ips

    - name: Add IPs to NetBox
      vars:
        ip_payload: |
          {
            "address": "{{ item }}/32"
          }
      uri:
        url: "{{ netbox_url }}ipam/ip-addresses/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body: "{{ ip_payload }}"
        body_format: json
        status_code: [201, 400]
      loop: "{{ live_ips }}"
      register: netbox_responses

    - name: Show NetBox response summary
      ansible.builtin.debug:
        msg: "Added {{ item.item }} - Status: {{ item.status }}"
      loop: "{{ netbox_responses.results }}"
